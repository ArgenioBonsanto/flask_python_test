name: Move card to In Review
on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    if: github.head_ref != 'main' && github.head_ref != 'develop'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PROJECTS_APP_ID }}
          private_key: ${{ secrets.PROJECTS_APP_PEM }}

      - name: Get Issue Id from Branch
        id: get-issue-id
        run: |
          # Extrae el número de issue del nombre de la rama (ej: "21" de "21-feat")
          BRANCH_NAME="${{ github.head_ref }}"
          ISSUE_ID=$(echo $BRANCH_NAME | cut -d'-' -f1)
          echo "issueId=$ISSUE_ID" >> $GITHUB_OUTPUT

      - name: Get project card ID
        id: getCardId
        uses: actions/github-script@v7
        env:
          USER_NAME: "ArgenioBonsanto"
          ISSUE_NUMBER: ${{ steps.get-issue-id.outputs.issueId }}
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const query = `query($user:String!) {
              user(login: $user) {
                projectsV2(first: 20) {
                  nodes {
                    id
                    title
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue { number }
                        }
                      }
                    }
                  }
                }
              }
            }`;
            const result = await github.graphql(query, { user: process.env.USER_NAME });
            
            // 1. Busca el proyecto llamado exactamente "mary"
            const project = result.user.projectsV2.nodes.find(p => p.title === "mary");
            if (!project) {
              console.log("No se encontró el proyecto 'mary'. Verifique el nombre.");
              return;
            }

            // 2. Busca la ficha del issue dentro del proyecto
            const targetNumber = parseInt(process.env.ISSUE_NUMBER);
            const item = project.items.nodes.find(i => i.content && i.content.number === targetNumber);
            
            if (item) {
              console.log(`¡Ficha encontrada! Item ID: ${item.id}`);
              core.setOutput('cardTicketId', item.id);
              core.setOutput('projectId', project.id);
            } else {
              console.log(`El issue #${targetNumber} no está asignado al proyecto 'mary' en GitHub.`);
            }

      - name: Move to In Review
        # Solo se ejecuta si el output no es nulo ni una cadena vacía
        if: steps.getCardId.outputs.cardTicketId != null && steps.getCardId.outputs.cardTicketId != ''
        env:
          PROJECT_ID: ${{ steps.getCardId.outputs.projectId }}
          FIELD_ID: ${{ secrets.PROJECT_STATUS_FIELD_ID }}
          OPTION_ID: ${{ secrets.PROJECT_IN_REVIEW_OPTION_ID }}
          ITEM_ID: ${{ steps.getCardId.outputs.cardTicketId }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api graphql -f query='
          mutation ($project: ID!, $fieldId: ID!, $optionId: String!, $itemId: ID!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $project, fieldId: $fieldId, itemId: $itemId, value: { singleSelectOptionId: $optionId }
            }) { projectV2Item { databaseId } }
          }' -F project=$PROJECT_ID -F fieldId=$FIELD_ID -F optionId=$OPTION_ID -f itemId=$ITEM_ID