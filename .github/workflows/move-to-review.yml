name: Move card to In Review
on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    # No se ejecuta si la rama de origen es main o develop
    if: github.head_ref != 'main' && github.head_ref != 'develop'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PROJECTS_APP_ID }}
          private_key: ${{ secrets.PROJECTS_APP_PEM }}

      - name: Get Issue Id from Branch
        id: get-issue-id
        run: |
          # Extrae el número antes del guion de la rama (ej: 21 de 21-add-cicd)
          BRANCH_NAME="${{ github.head_ref }}"
          ISSUE_ID=$(echo $BRANCH_NAME | cut -d'-' -f1)
          echo "issueId=$ISSUE_ID" >> $GITHUB_OUTPUT

      - name: Get project card ID
        id: getCardId
        uses: actions/github-script@v7
        env:
          OWNER_NAME: "ArgenioBonsanto"
          REPO_NAME: "flask_python_test"
          ISSUE_ID: ${{ steps.get-issue-id.outputs.issueId }}
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const query = `query($owner:String!, $repo:String!, $issue:Int!) {
              repository(owner:$owner, name:$repo) {
                issue(number:$issue) {
                  projectItems(first:10) {
                    nodes {
                      id
                      project { title }
                    }
                  }
                }
              }
            }`;
            const variables = {
              owner: process.env.OWNER_NAME,
              repo: process.env.REPO_NAME,
              issue: parseInt(process.env.ISSUE_ID)
            };
            
            try {
              const result = await github.graphql(query, variables);
              const items = result.repository.issue.projectItems.nodes;
              // Buscamos específicamente el item en el proyecto llamado 'mary'
              const targetItem = items.find(item => item.project.title === 'mary');
              
              if (targetItem) {
                console.log(`ID de tarjeta encontrado: ${targetItem.id}`);
                core.setOutput('cardTicketId', targetItem.id);
              } else {
                console.log("El issue no está vinculado al proyecto 'mary'");
              }
            } catch (error) {
              core.setFailed(`Error en la consulta GraphQL: ${error.message}`);
            }

      - name: Move to In Review
        # Solo se ejecuta si cardTicketId tiene un valor real y no es nulo
        if: steps.getCardId.outputs.cardTicketId != '' && steps.getCardId.outputs.cardTicketId != null
        env:
          PROJECT_ID: ${{ secrets.PROJECTS_MARY_PROJECT_ID }}
          FIELD_ID: ${{ secrets.PROJECT_STATUS_FIELD_ID }}
          OPTION_ID: ${{ secrets.PROJECT_IN_REVIEW_OPTION_ID }}
          ITEM_ID: ${{ steps.getCardId.outputs.cardTicketId }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api graphql -f query='
          mutation ($project: ID!, $fieldId: ID!, $optionId: String!, $itemId: ID!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $project, fieldId: $fieldId, itemId: $itemId, value: { singleSelectOptionId: $optionId }
            }) { projectV2Item { databaseId } }
          }' -F project=$PROJECT_ID -F fieldId=$FIELD_ID -F optionId=$OPTION_ID -f itemId=$ITEM_ID