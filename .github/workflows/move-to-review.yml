name: Move card to In Review
on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    if: github.head_ref != 'main' && github.head_ref != 'develop'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PROJECTS_APP_ID }}
          private_key: ${{ secrets.PROJECTS_APP_PEM }}

      - name: Get Issue Id from Branch
        id: get-issue-id
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          ISSUE_ID=$(echo $BRANCH_NAME | cut -d'-' -f1)
          echo "issueId=$ISSUE_ID" >> $GITHUB_OUTPUT

      - name: Get project card ID
        id: getCardId
        uses: actions/github-script@v7
        env:
          OWNER_NAME: "ArgenioBonsanto"
          ISSUE_NUMBER: ${{ steps.get-issue-id.outputs.issueId }}
          PROJECT_ID: ${{ secrets.PROJECTS_MARY_PROJECT_ID }}
        with:
          github-token: ${{ steps.generate_token.outputs.token }}
          script: |
            const query = `query($project:ID!) {
              node(id: $project) {
                ... on ProjectV2 {
                  items(first: 100) {
                    nodes {
                      id
                      content {
                        ... on Issue { number }
                        ... on PullRequest { number }
                      }
                    }
                  }
                }
              }
            }`;
            const variables = { project: process.env.PROJECT_ID };
            const result = await github.graphql(query, variables);
            
            const targetIssueNumber = parseInt(process.env.ISSUE_NUMBER);
            const items = result.node.items.nodes;
            
            // Buscamos el item cuyo contenido sea el issue con nuestro número
            const targetItem = items.find(item => item.content && item.content.number === targetIssueNumber);
            
            if (targetItem) {
              console.log(`Ficha encontrada! ID: ${targetItem.id}`);
              core.setOutput('cardTicketId', targetItem.id);
            } else {
              console.log(`No se encontró el issue #${targetIssueNumber} en el proyecto.`);
              // No establecemos output para que el siguiente paso se salte correctamente
            }

      - name: Move to In Review
        # IMPORTANTE: Cambiamos la validación para que sea compatible con lo que GitHub ve en el log
        if: steps.getCardId.outputs.cardTicketId != null && steps.getCardId.outputs.cardTicketId != ''
        env:
          PROJECT_ID: ${{ secrets.PROJECTS_MARY_PROJECT_ID }}
          FIELD_ID: ${{ secrets.PROJECT_STATUS_FIELD_ID }}
          OPTION_ID: ${{ secrets.PROJECT_IN_REVIEW_OPTION_ID }}
          ITEM_ID: ${{ steps.getCardId.outputs.cardTicketId }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api graphql -f query='
          mutation ($project: ID!, $fieldId: ID!, $optionId: String!, $itemId: ID!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $project, fieldId: $fieldId, itemId: $itemId, value: { singleSelectOptionId: $optionId }
            }) { projectV2Item { databaseId } }
          }' -F project=$PROJECT_ID -F fieldId=$FIELD_ID -F optionId=$OPTION_ID -f itemId=$ITEM_ID