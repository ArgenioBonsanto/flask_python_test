name: Move card to In Review
on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    # Se ejecuta solo si la rama no es main ni develop
    if: github.head_ref != 'main' && github.head_ref != 'develop'
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PROJECTS_APP_ID }}
          private_key: ${{ secrets.PROJECTS_APP_PEM }}

      - name: Find and Move Card
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          OWNER: "ArgenioBonsanto"
          PROJECT_NAME: "mary"
        run: |
          # 1. Extraer el número de issue del nombre de la rama (ej: 21 de 21-add-cicd)
          ISSUE_NUM=$(echo "${{ github.head_ref }}" | cut -d'-' -f1)
          echo "Procesando Issue #$ISSUE_NUM..."

          # 2. Obtener el ID global del proyecto buscando por nombre
          PROJECT_ID=$(gh project list --owner "$OWNER" --format json --jq ".projects[] | select(.title == \"$PROJECT_NAME\") | .id")
          
          if [ -z "$PROJECT_ID" ]; then
            echo "ERROR: No se encontró el proyecto con nombre '$PROJECT_NAME'"
            exit 1
          fi
          echo "ID del Proyecto ($PROJECT_NAME) localizado: $PROJECT_ID"

          # 3. Obtener el ID de la ficha (Item ID) del issue específico
          ITEM_ID=$(gh project item-list "$PROJECT_ID" --owner "$OWNER" --format json --jq ".items[] | select(.content.number == ($ISSUE_NUM | tonumber)) | .id")

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" == "null" ]; then
            echo "ERROR: No se encontró la ficha del issue #$ISSUE_NUM en el proyecto."
            exit 1
          fi
          echo "Ficha localizada con éxito: $ITEM_ID"

          # 4. Mover la ficha a la columna 'In review' (basado en image_1b4bb4.png)
          gh project item-edit --id "$ITEM_ID" --field "Status" --project-id "$PROJECT_ID" --owner "$OWNER" --single-select-option "In review"
          
          echo "¡Movimiento a 'In review' completado con éxito!"