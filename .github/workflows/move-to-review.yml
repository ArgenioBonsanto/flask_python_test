name: Move card to In Review
on:
  pull_request:
    types: [opened, reopened]

jobs:
  move-to-review:
    runs-on: ubuntu-latest
    if: ${{ github.head_ref != 'main' && github.head_ref != 'develop' }}
    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.PROJECTS_APP_ID }}
          private_key: ${{ secrets.PROJECTS_APP_PEM }}

      - name: Get Issue Id from Branch
        id: get-issue-id
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.head_ref }}
        with:
          script: |
            const branchName = process.env.BRANCH;
            const issueId = branchName.split('-')[0];
            console.log(`Buscando Issue ID: ${issueId}`);
            core.setOutput('issueId', issueId);

      - name: Get project card ID
        id: getCardId
        env:
          OWNER_NAME: "ArgenioBonsanto"
          REPO_NAME: "flask_python_test"
          ISSUE_ID: ${{ steps.get-issue-id.outputs.issueId }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api graphql -f query='
            query ($owner: String!, $repo: String!, $issue: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issue) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project { title }
                    }
                  }
                }
              }
            }' -f owner=$OWNER_NAME -f repo=$REPO_NAME -F issue=$ISSUE_ID > issue_info.json
          
          # Debug: Ver contenido del JSON en los logs
          cat issue_info.json
          
          # Buscamos el ID filtrando exactamente por el nombre "mary"
          CARD_ID=$(jq -r '.data.repository.issue.projectItems.nodes[] | select(.project.title=="mary") | .id' issue_info.json)
          
          if [ -z "$CARD_ID" ] || [ "$CARD_ID" == "null" ]; then
            echo "Error: No se encontrÃ³ la ficha #$ISSUE_ID en el proyecto mary."
            echo "cardTicketId=null" >> $GITHUB_OUTPUT
          else
            echo "Ficha encontrada con ID: $CARD_ID"
            echo "cardTicketId=$CARD_ID" >> $GITHUB_OUTPUT
          fi

      - name: Move to In Review
        if: steps.getCardId.outputs.cardTicketId != 'null' && steps.getCardId.outputs.cardTicketId != ''
        env:
          PROJECT_ID: ${{ secrets.PROJECTS_MARY_PROJECT_ID }}
          FIELD_ID: ${{ secrets.PROJECT_STATUS_FIELD_ID }}
          OPTION_ID: ${{ secrets.PROJECT_IN_REVIEW_OPTION_ID }}
          ITEM_ID: ${{ steps.getCardId.outputs.cardTicketId }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api graphql -f query='
          mutation ($project: ID!, $fieldId: ID!, $optionId: String!, $itemId: ID!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $project, fieldId: $fieldId, itemId: $itemId, value: { singleSelectOptionId: $optionId }
            }) { projectV2Item { databaseId } }
          }' -F project=$PROJECT_ID -F fieldId=$FIELD_ID -F optionId=$OPTION_ID -f itemId=$ITEM_ID